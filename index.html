<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Oxford 3000 Pro - Modern Edition</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;600;800&display=swap" rel="stylesheet">
    
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>

    <style>
        :root { --primary: #4f46e5; --primary-light: #818cf8; --success: #10b981; --expert: #059669; --warning: #f59e0b; --error: #ef4444; --bg: #f1f5f9; --text: #0f172a; --card: #ffffff; }
        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
        body { font-family: 'Plus Jakarta Sans', sans-serif; background: var(--bg); display: flex; justify-content: center; align-items: center; min-height: 100vh; margin: 0; color: var(--text); overflow-x: hidden; }
        
        /* Glassmorphism Container */
        .container { background: var(--card); width: 100%; max-width: 480px; min-height: 100vh; padding: 24px; position: relative; display: flex; flex-direction: column; transition: all 0.3s ease; }
        @media (min-width: 500px) { .container { min-height: auto; border-radius: 32px; box-shadow: 0 25px 50px -12px rgba(0,0,0,0.1); margin: 20px; } }

        /* User Overlay - Full Screen Blur */
        #user-overlay { position: fixed; inset: 0; background: rgba(241, 245, 249, 0.95); backdrop-filter: blur(12px); z-index: 2000; display: flex; flex-direction: column; align-items: center; justify-content: center; padding: 30px; }
        .user-card { background: white; width: 100%; max-width: 320px; padding: 18px; margin: 10px 0; border-radius: 20px; display: flex; justify-content: space-between; align-items: center; cursor: pointer; border: 1px solid #e2e8f0; transition: transform 0.2s, box-shadow 0.2s; box-shadow: 0 4px 6px -1px rgba(0,0,0,0.05); }
        .user-card:hover { transform: translateY(-2px); box-shadow: 0 10px 15px -3px rgba(0,0,0,0.1); }
        .del-user { color: var(--error); font-weight: 800; padding: 8px; font-size: 0.8rem; background: #fee2e2; border-radius: 10px; }

        /* Google Login Button Style */
        .google-btn { background: white; color: var(--text); border: 1px solid #e2e8f0; padding: 15px; border-radius: 20px; font-weight: 700; cursor: pointer; display: flex; align-items: center; gap: 10px; margin-bottom: 20px; width: 100%; max-width: 320px; box-shadow: 0 4px 6px -1px rgba(0,0,0,0.05); transition: all 0.2s; }
        .google-btn:hover { background: #f8fafc; transform: translateY(-1px); }

        /* Modern Menu Bar */
        .menu-bar { display: flex; justify-content: space-between; align-items: center; margin-bottom: 24px; background: #f8fafc; border-radius: 20px; padding: 8px; border: 1px solid #f1f5f9; }
        .menu-item { font-size: 0.7rem; font-weight: 800; cursor: pointer; color: #64748b; padding: 10px 14px; border-radius: 14px; transition: all 0.2s; display: flex; align-items: center; gap: 5px; }
        .active-user { color: var(--primary); background: white; box-shadow: 0 4px 6px -1px rgba(0,0,0,0.05); }

        /* Filter Panel Responsive */
        .filter-panel { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-bottom: 24px; }
        select { appearance: none; background: #f1f5f9; border: 2px solid transparent; padding: 12px; border-radius: 16px; font-weight: 600; font-size: 0.85rem; color: #475569; outline: none; cursor: pointer; transition: border 0.2s; }
        select:focus { border-color: var(--primary-light); background: white; }

        /* Word Presentation Area */
        #target-word { font-size: 3.2rem; font-weight: 800; margin: 20px 0; color: #1e293b; letter-spacing: -1.5px; line-height: 1.1; min-height: 100px; display: flex; align-items: center; justify-content: center; animation: fadeIn 0.4s ease; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        
        .tags-container { display: flex; justify-content: center; gap: 8px; margin-bottom: 10px; }
        .tag { padding: 6px 14px; border-radius: 12px; font-size: 0.7rem; font-weight: 800; text-transform: uppercase; letter-spacing: 0.5px; }
        .tag-lvl { background: #e0e7ff; color: #4338ca; }
        .tag-info { background: #fef3c7; color: #92400e; }

        /* Input & Interaction */
        .input-group { position: relative; margin-top: auto; }
        input { width: 100%; padding: 20px; border: 2px solid #e2e8f0; border-radius: 20px; font-size: 1.1rem; font-weight: 600; outline: none; text-align: center; transition: all 0.3s; background: #f8fafc; }
        input:focus { border-color: var(--primary); background: white; box-shadow: 0 0 0 4px rgba(79, 70, 229, 0.1); }
        
        #action-btn { width: 100%; padding: 20px; border: none; border-radius: 20px; background: var(--primary); color: white; font-size: 1.1rem; font-weight: 700; cursor: pointer; margin-top: 16px; transition: all 0.3s; box-shadow: 0 10px 15px -3px rgba(79, 70, 229, 0.3); }
        #action-btn:active { transform: scale(0.98); }
        
        .shake { animation: shake 0.4s cubic-bezier(.36,.07,.19,.97) both; border-color: var(--warning) !important; }
        @keyframes shake { 10%, 90% { transform: translate3d(-1px, 0, 0); } 20%, 80% { transform: translate3d(2px, 0, 0); } 30%, 50%, 70% { transform: translate3d(-4px, 0, 0); } 40%, 60% { transform: translate3d(4px, 0, 0); } }

        /* Modals Modern */
        .modal { display: none; position: fixed; inset: 0; background: rgba(15, 23, 42, 0.6); backdrop-filter: blur(8px); z-index: 3000; align-items: center; justify-content: center; padding: 20px; }
        .modal-content { background: white; width: 100%; max-width: 400px; border-radius: 28px; padding: 28px; box-shadow: 0 25px 50px -12px rgba(0,0,0,0.25); position: relative; max-height: 80vh; overflow-y: auto; }
        
        /* Stats Visuals */
        .progress-row { margin-bottom: 20px; padding: 15px; background: #f8fafc; border-radius: 18px; border: 1px solid #f1f5f9; }
        .progress-bar { background: #e2e8f0; height: 12px; border-radius: 6px; overflow: hidden; margin: 8px 0; }
        .progress-fill { height: 100%; background: linear-gradient(90deg, var(--primary-light), var(--primary)); transition: width 0.8s cubic-bezier(0.34, 1.56, 0.64, 1); }
        .expert-fill { height: 100%; background: linear-gradient(90deg, var(--success), var(--expert)); transition: width 0.8s; }
        
        #feedback { font-weight: 700; margin-bottom: 10px; font-size: 1rem; transition: all 0.2s; }
    </style>
</head>
<body>

<div id="user-overlay">
    <div style="text-align:center; margin-bottom:30px">
        <h1 style="font-weight:800; font-size:2rem; margin:0; letter-spacing:-1px">Oxford 3000<span style="color:var(--primary)">.</span></h1>
        <p style="color:#64748b; font-weight:600">√ñƒürenme yolculuƒüuna ba≈üla</p>
    </div>

    <button class="google-btn" onclick="loginWithGoogle()">
        <img src="https://www.gstatic.com/firebasejs/ui/2.0.0/images/auth/google.svg" width="18">
        Google ile Giri≈ü Yap
    </button>
    <div style="color:#cbd5e1; font-size:0.8rem; margin-bottom:15px;">‚Äî VEYA YEREL DEVAM ET ‚Äî</div>

    <div id="user-list" style="width:100%; display:flex; flex-direction:column; align-items:center; max-height:30vh; overflow-y:auto; padding:10px"></div>
    <div style="width:100%; max-width:320px; margin-top:20px; padding-top:20px; border-top:2px solid #e2e8f0">
        <input type="text" id="new-username" placeholder="Yeni √ñƒürenci ƒ∞smi" style="font-size:0.95rem; padding:15px; background:white">
        <button onclick="createUser()" style="width:100%; margin-top:12px; padding:15px; border-radius:18px; background:var(--text); color:white; border:none; font-weight:700; cursor:pointer">PROFƒ∞L OLU≈ûTUR</button>
    </div>
</div>

<div class="container">
    <div class="menu-bar">
        <div id="active-user-name" class="menu-item active-user" onclick="location.reload()">üë§ Profil</div>
        <div class="menu-item" onclick="toggleModal('mistake-modal', true)">‚ö†Ô∏èHATALAR <span id="wrong-count" style="margin-left:4px">0</span></div>
        <div class="menu-item" onclick="openStats()">üìä KELƒ∞METƒ∞STƒ∞K</div>
    </div>

    <div class="filter-panel">
        <select id="level-filter" onchange="applyFilters()"><option value="ALL">Seviye: T√ºm√º</option><option value="A1">Seviye A1</option><option value="A2">Seviye A2</option><option value="B1">Seviye B1</option><option value="B2">Seviye B2</option><option value="C1">Seviye C1</option></select>
        <select id="type-filter" onchange="applyFilters()"><option value="ALL">T√ºr: T√ºm√º</option><option value="v.">Fiiller (v.)</option><option value="n.">ƒ∞simler (n.)</option><option value="adj.">Sƒ±fatlar (adj.)</option><option value="adv.">Zarflar (adv.)</option></select>
    </div>

    <div class="tags-container" id="tags-box"></div>
    <div onclick="speakWord()" style="cursor:pointer; margin-bottom:20px">
        <div id="target-word">...</div>
        <div style="font-size: 0.75rem; color: var(--primary); font-weight: 800; letter-spacing: 1px; text-align:center">üîä TELAFFUZU Dƒ∞NLE</div>
    </div>

    <div class="input-group">
        <div id="feedback"></div>
        <input type="text" id="user-input" placeholder="T√ºrk√ße kar≈üƒ±lƒ±ƒüƒ±nƒ± yaz..." autocomplete="off">
        <button id="action-btn">KONTROL ET</button>
    </div>
</div>

<div id="stats-modal" class="modal">
    <div class="modal-content">
        <h2 style="font-weight:800; margin-bottom:20px">Geli≈üim Analizi</h2>
        <div style="position:relative; margin-bottom:20px">
            <canvas id="statsChart" style="max-height:160px;"></canvas>
        </div>
        <div id="level-bars"></div>
        <button onclick="toggleModal('stats-modal', false)" style="width:100%; margin-top:10px; padding:15px; border-radius:16px; border:none; background:#f1f5f9; color:var(--text); font-weight:700; cursor:pointer">KAPAT</button>
    </div>
</div>

<div id="mistake-modal" class="modal">
    <div class="modal-content">
        <h2 style="font-weight:800; margin-bottom:20px">Hatalƒ± Kelimeler</h2>
        <div id="mistake-list-container" style="max-height:50vh; overflow-y:auto"></div>
        <button onclick="toggleModal('mistake-modal', false)" style="width:100%; margin-top:20px; padding:15px; border-radius:16px; border:none; background:#f1f5f9; color:var(--text); font-weight:700">KAPAT</button>
    </div>
</div>

<script>
    // --- FIREBASE CONFIG ---
    const firebaseConfig = {
        apiKey: "AIzaSyCM5M27q4r-gxhkQoc1XEyGU7JCI1Nzk5M",
        authDomain: "kelimelik-43169.firebaseapp.com",
        projectId: "kelimelik-43169",
        storageBucket: "kelimelik-43169.firebasestorage.app",
        messagingSenderId: "1065593596358",
        appId: "1:1065593596358:web:d34ad0df91fd9efd252ac7"
    };
    firebase.initializeApp(firebaseConfig);
    const auth = firebase.auth();
    const db = firebase.firestore();

    // --- APP LOGIC ---
    let masterDict = [];
    let users = JSON.parse(localStorage.getItem('ox_users')) || [];
    let currentUser = null;
    let srsData = {};
    let filteredDict = [];
    let currentItem = null, myChart = null, secondChanceActive = false;
    const levels = ['A1', 'A2', 'B1', 'B2', 'C1'], types = ['v.', 'n.', 'adj.', 'adv.'];

    function initUserSystem() {
        const list = document.getElementById('user-list');
        list.innerHTML = "";
        users.forEach(u => {
            const div = document.createElement('div');
            div.className = 'user-card';
            div.innerHTML = `<span onclick="selectUser('${u}')" style="flex:1; font-weight:700;">${u}</span><span class="del-user" onclick="deleteUser('${u}')">Sƒ∞L</span>`;
            list.appendChild(div);
        });
    }

    async function loginWithGoogle() {
        const provider = new firebase.auth.GoogleAuthProvider();
        try {
            const result = await auth.signInWithPopup(provider);
            const user = result.user;
            currentUser = user.displayName;
            
            // Buluttan veriyi getir
            const doc = await db.collection("users").doc(user.uid).get();
            srsData = doc.exists ? (doc.data().srsData || {}) : {};
            
            // Aray√ºz√º g√ºncelle
            document.getElementById('user-overlay').style.display = 'none';
            document.getElementById('active-user-name').innerText = "üë§ " + currentUser;
            loadCSV();
        } catch (error) {
            console.error(error);
            alert("Google ile giri≈ü ba≈üarƒ±sƒ±z.");
        }
    }

    function createUser() {
        const name = document.getElementById('new-username').value.trim();
        if(!name || users.includes(name)) return alert("Ge√ßersiz isim!");
        users.push(name);
        localStorage.setItem('ox_users', JSON.stringify(users));
        document.getElementById('new-username').value = "";
        initUserSystem();
    }

    function deleteUser(name) {
        if(!confirm(name + " silinsin mi?")) return;
        users = users.filter(u => u !== name);
        localStorage.removeItem('ox_srs_' + name);
        localStorage.setItem('ox_users', JSON.stringify(users));
        initUserSystem();
    }

    function selectUser(name) {
        currentUser = name;
        const savedData = localStorage.getItem('ox_srs_' + name);
        srsData = savedData ? JSON.parse(savedData) : {};
        document.getElementById('user-overlay').style.display = 'none';
        document.getElementById('active-user-name').innerText = "üë§ " + name;
        loadCSV();
    }

    async function loadCSV() {
        try {
            const res = await fetch('kelimeler.csv');
            const data = await res.text();
            const rows = data.split('\n').slice(1);
            let fileWords = [];
            rows.forEach(row => {
                const cols = row.split(/,(?=(?:(?:[^"]*"){2})*[^"]*$)/).map(c => c.trim().replace(/^"|"$/g, ''));
                if(cols[0] && cols[cols.length-1]) {
                    fileWords.push({ eng: cols[0], tr: cols[cols.length-1], level: cols.find(c => levels.includes(c.toUpperCase())) || "A1", types: [cols.find(c => types.includes(c.toLowerCase())) || "n."] });
                }
            });
            masterDict = [...fileWords];
            applyFilters();
            updateUI();
        } catch (e) { console.error("CSV y√ºklenemedi."); }
    }

    function applyFilters() {
        const sL = document.getElementById('level-filter').value;
        const sT = document.getElementById('type-filter').value;
        filteredDict = masterDict.filter(i => (sL === "ALL" || i.level === sL) && (sT === "ALL" || i.types.includes(sT)));
        getNextWord();
    }

    function getNextWord() {
        if (!filteredDict.length) return document.getElementById('target-word').innerText = "Liste Bo≈ü";
        secondChanceActive = false;
        const mists = filteredDict.filter(i => srsData[i.eng]?.isMistake);
        currentItem = (mists.length > 0 && Math.random() < 0.3) ? mists[Math.floor(Math.random() * mists.length)] : filteredDict[Math.floor(Math.random() * filteredDict.length)];
        renderWord();
    }

    function renderWord() {
        document.getElementById('target-word').innerText = currentItem.eng;
        document.getElementById('tags-box').innerHTML = `<span class="tag tag-lvl">${currentItem.level}</span><span class="tag tag-info">${currentItem.types[0]}</span>`;
        const inp = document.getElementById('user-input');
        inp.value = ""; inp.disabled = false; inp.focus(); inp.classList.remove('shake');
        document.getElementById('action-btn').innerText = "KONTROL ET";
        document.getElementById('action-btn').style.background = "var(--primary)";
        document.getElementById('action-btn').onclick = checkAnswer;
        document.getElementById('feedback').innerText = "";
    }

    function checkAnswer() {
        const val = document.getElementById('user-input').value.trim().toLowerCase();
        const ans = currentItem.tr.toLowerCase().split(',').map(a => a.trim());
        const fb = document.getElementById('feedback');
        if (ans.includes(val)) {
            fb.innerText = "‚ú® HARƒ∞KA!"; fb.style.color = "var(--success)";
            if (!srsData[currentItem.eng]) srsData[currentItem.eng] = { level: 0, isMistake: false };
            srsData[currentItem.eng].level++; 
            srsData[currentItem.eng].isMistake = false;
            finalizeRound(true);
        } else {
            if (!secondChanceActive) {
                fb.innerText = "üéØ Tekrar dene!"; fb.style.color = "var(--warning)";
                document.getElementById('user-input').classList.add('shake'); secondChanceActive = true;
                setTimeout(() => document.getElementById('user-input').classList.remove('shake'), 400);
            } else {
                fb.innerText = `üí° Cevap: ${currentItem.tr}`; fb.style.color = "var(--error)";
                if (!srsData[currentItem.eng]) srsData[currentItem.eng] = { level: 0, isMistake: false };
                srsData[currentItem.eng].isMistake = true;
                finalizeRound(false);
            }
        }
    }

    function finalizeRound(isCorrect) {
        // Yerel Kayƒ±t
        localStorage.setItem('ox_srs_' + currentUser, JSON.stringify(srsData));
        
        // Google ile girilmi≈üse Bulut Kaydƒ±
        if (auth.currentUser) {
            db.collection("users").doc(auth.currentUser.uid).set({
                srsData: srsData,
                lastUpdated: firebase.firestore.FieldValue.serverTimestamp()
            }, { merge: true });
        }

     updateUI();
    
    const actionBtn = document.getElementById('action-btn');
    const userInput = document.getElementById('user-input');

    userInput.disabled = true;
    actionBtn.innerText = "SIRADAKƒ∞";
    actionBtn.style.background = isCorrect ? "var(--success)" : "var(--error)";
    actionBtn.onclick = getNextWord;

    // --- OTOMATƒ∞K GE√áƒ∞≈û MANTIƒûI ---
    // Eƒüer doƒüruysa 1 saniye bekle, yanlƒ±≈üsa cevabƒ± g√∂rmesi i√ßin 3 saniye bekle
    const delay = isCorrect ? 1000 : 3000;

    // Mevcut bir otomatik ge√ßi≈üi iptal etmek i√ßin (√ºst √ºste binmemesi i√ßin)
    if (window.autoNextTimeout) clearTimeout(window.autoNextTimeout);

    window.autoNextTimeout = setTimeout(() => {
        // Eƒüer kullanƒ±cƒ± zaten manuel olarak 'Sƒ±radaki'ne basmadƒ±ysa ge√ß
        if (userInput.disabled) { 
            getNextWord();
        }
    }, delay);
}

    function updateUI() {
        const mCount = Object.values(srsData).filter(v => v.isMistake).length;
        document.getElementById('wrong-count').innerText = mCount;
        const mList = masterDict.filter(i => srsData[i.eng]?.isMistake);
        document.getElementById('mistake-list-container').innerHTML = mList.map(m => `<div style="padding:15px; border-bottom:1px solid #f1f5f9; display:flex; justify-content:space-between"><b>${m.eng}</b> <span style="color:#64748b">${m.tr}</span></div>`).join('');
    }

    function openStats() {
        toggleModal('stats-modal', true);
        const data = Object.values(srsData);
        const stats = { new: masterDict.length - data.length, learn: data.filter(v => v.level > 0 && v.level < 4 && !v.isMistake).length, exp: data.filter(v => v.level >= 4).length, mist: data.filter(v => v.isMistake).length };
        const ctx = document.getElementById('statsChart').getContext('2d');
        if(myChart) myChart.destroy();
        myChart = new Chart(ctx, { type: 'doughnut', data: { labels: ['Yeni', '√ñƒüreniliyor', 'Uzman', 'Hatalƒ±'], datasets: [{ data: [stats.new, stats.learn, stats.exp, stats.mist], backgroundColor: ['#e2e8f0','#4f46e5','#10b981','#ef4444'], borderWeight:0 }] }, options: { plugins: { legend: { display: false } }, cutout: '75%', borderRadius: 10 } });
        let h = "";
        levels.forEach(l => {
            const total = masterDict.filter(i => i.level === l).length;
            const lr = masterDict.filter(i => i.level === l && srsData[i.eng]?.level > 0).length;
            const ex = masterDict.filter(i => i.level === l && srsData[i.eng]?.level >= 4).length;
            const pL = total > 0 ? Math.round((lr/total)*100) : 0;
            const pE = total > 0 ? Math.round((ex/total)*100) : 0;
            h += `<div class="progress-row"><div style="display:flex; justify-content:space-between; font-size:0.75rem; font-weight:800; margin-bottom:5px"><span>${l} Seviyesi</span><span>${lr}/${total}</span></div><div class="progress-bar"><div class="progress-fill" style="width:${pL}%"></div></div><div style="display:flex; justify-content:space-between; font-size:0.65rem; color:var(--expert); font-weight:800;"><span>Uzmanlƒ±k Derecesi</span><span>%${pE}</span></div><div class="progress-bar" style="height:6px"><div class="expert-fill" style="width:${pE}%"></div></div></div>`;
        });
        document.getElementById('level-bars').innerHTML = h;
    }

    function speakWord() { window.speechSynthesis.cancel(); const u = new SpeechSynthesisUtterance(currentItem.eng); u.lang = 'en-US'; u.rate = 0.85; window.speechSynthesis.speak(u); }
    function toggleModal(id, show) { document.getElementById(id).style.display = show ? 'flex' : 'none'; }
    document.getElementById('user-input').addEventListener("keypress", (e) => { if(e.key === "Enter") document.getElementById('action-btn').click(); });
    window.onload = initUserSystem;
const settingsHTML = `
<div id="settings-modal" class="modal">
    <div class="modal-content">
        <h2 style="font-weight:800; margin-bottom:20px">Ayarlar</h2>
        <div style="display:flex; justify-content:space-between; align-items:center; padding:15px; background:#f8fafc; border-radius:18px; margin-bottom:20px">
            <span style="font-weight:600">Otomatik Ses (ƒ∞ngilizce)</span>
            <label class="switch">
                <input type="checkbox" id="auto-speak-toggle" onchange="toggleAutoSpeak(this.checked)">
                <span class="slider"></span>
            </label>
        </div>
        <button onclick="toggleModal('settings-modal', false)" style="width:100%; padding:15px; border-radius:16px; border:none; background:var(--primary); color:white; font-weight:700; cursor:pointer">KAYDET VE KAPAT</button>
    </div>
</div>

<style>
/* Toggle Switch Tasarƒ±mƒ± */
.switch { position: relative; display: inline-block; width: 50px; height: 26px; }
.switch input { opacity: 0; width: 0; height: 0; }
.slider { position: absolute; cursor: pointer; inset: 0; background-color: #cbd5e1; transition: .4s; border-radius: 34px; }
.slider:before { position: absolute; content: ""; height: 18px; width: 18px; left: 4px; bottom: 4px; background-color: white; transition: .4s; border-radius: 50%; }
input:checked + .slider { background-color: var(--success); }
input:checked + .slider:before { transform: translateX(24px); }
</style>
`;
document.body.insertAdjacentHTML('beforeend', settingsHTML);
const menuBar = document.querySelector('.menu-bar');
const settingsBtn = document.createElement('div');
settingsBtn.className = 'menu-item';
settingsBtn.innerHTML = '‚öôÔ∏è AYARLAR';
settingsBtn.onclick = () => toggleModal('settings-modal', true);
menuBar.appendChild(settingsBtn);
let autoSpeakEnabled = localStorage.getItem('ox_auto_speak') === 'true';
document.getElementById('auto-speak-toggle').checked = autoSpeakEnabled;

function toggleAutoSpeak(isEnabled) {
    autoSpeakEnabled = isEnabled;
    localStorage.setItem('ox_auto_speak', isEnabled);
}
const originalRenderWord = renderWord;
renderWord = function() {
    originalRenderWord(); // Eski renderWord fonksiyonunu √ßalƒ±≈ütƒ±r
    if (autoSpeakEnabled && currentItem) {
        setTimeout(() => speakWord(), 300);
    }
};
window.speakWord = function() {
    window.speechSynthesis.cancel();
    const utterance = new SpeechSynthesisUtterance(currentItem.eng);
    utterance.lang = 'en-US';
    utterance.rate = 0.9; // Daha doƒüal bir hƒ±z
    utterance.pitch = 1; 
    window.speechSynthesis.speak(utterance);
};
const settingsContainer = document.querySelector('#settings-modal .modal-content');
const darkModeHTML = `
<div style="display:flex; justify-content:space-between; align-items:center; padding:15px; background:#f8fafc; border-radius:18px; margin-bottom:20px">
    <span style="font-weight:600">Karanlƒ±k Mod (Dark Mode)</span>
    <label class="switch">
        <input type="checkbox" id="dark-mode-toggle" onchange="toggleDarkMode(this.checked)">
        <span class="slider"></span>
    </label>
</div>
`;
settingsContainer.querySelector('button').insertAdjacentHTML('beforebegin', darkModeHTML);
const darkStyles = `
<style id="dark-mode-styles">
    body.dark-mode { --bg: #0f172a; --text: #f8fafc; --card: #1e293b; }
    body.dark-mode .container { background: var(--card); border-color: #334155; }
    body.dark-mode input { background: #334155; border-color: #475569; color: white; }
    body.dark-mode select { background: #334155; color: #cbd5e1; }
    body.dark-mode .menu-bar { background: #334155; border-color: #475569; }
    body.dark-mode .active-user { background: #1e293b; color: var(--primary-light); }
    body.dark-mode #target-word { color: white; }
    body.dark-mode #user-overlay { background: rgba(15, 23, 42, 0.95); }
    body.dark-mode .user-card, body.dark-mode .modal-content { background: #1e293b; color: white; border-color: #334155; }
    body.dark-mode .progress-row { background: #334155; border-color: #475569; }
    body.dark-mode .tag-lvl { background: #312e81; color: #c7d2fe; }
    body.dark-mode #settings-modal div[style*="background:#f8fafc"] { background: #334155 !important; }
</style>
`;
document.head.insertAdjacentHTML('beforeend', darkStyles);
let darkModeEnabled = localStorage.getItem('ox_dark_mode') === 'true';
document.getElementById('dark-mode-toggle').checked = darkModeEnabled;

function applyDarkMode(isDark) {
    if (isDark) {
        document.body.classList.add('dark-mode');
    } else {
        document.body.classList.remove('dark-mode');
    }
}

function toggleDarkMode(isEnabled) {
    darkModeEnabled = isEnabled;
    localStorage.setItem('ox_dark_mode', isEnabled);
    applyDarkMode(isEnabled);
}
applyDarkMode(darkModeEnabled);
const originalGetNextWord = getNextWord;
getNextWord = function() {
    if (!filteredDict.length) return originalGetNextWord();

    const now = Date.now();
    let dueWords = filteredDict.filter(item => {
        const data = srsData[item.eng];
        if (!data) return true; // Hi√ß g√∂r√ºlmemi≈ü kelime
        if (data.isMistake) return true; // Hatalƒ± kelime
        
        // Bir sonraki g√∂r√ºlme zamanƒ± gelmi≈ü mi? (Default: 0)
        return !data.nextReview || now >= data.nextReview;
    });
    if (dueWords.length === 0) {
        dueWords = filteredDict;
    }

    // %20 ihtimalle hatalƒ± kelimelere √∂ncelik ver
    const mistakes = dueWords.filter(i => srsData[i.eng]?.isMistake);
    if (mistakes.length > 0 && Math.random() < 0.2) {
        currentItem = mistakes[Math.floor(Math.random() * mistakes.length)];
    } else {
        currentItem = dueWords[Math.floor(Math.random() * dueWords.length)];
    }

    secondChanceActive = false;
    renderWord();
};
const originalFinalizeRound = finalizeRound;
finalizeRound = function(isCorrect) {
    if (!srsData[currentItem.eng]) {
        srsData[currentItem.eng] = { level: 0, isMistake: false, nextReview: 0 };
    }

    const data = srsData[currentItem.eng];
    const now = Date.now();

    if (isCorrect) {
        data.level++;
        // Seviyeye g√∂re bekleme s√ºresi (Dakika bazlƒ± √∂rnek: 2^level * 10 dk)
        // Profesyonel SRS: Seviye 1: 10dk, Seviye 2: 1 saat, Seviye 3: 5 saat, Seviye 4: 1 g√ºn...
        const intervals = [0, 10, 60, 300, 1440, 4320, 10080]; // Dakika cinsinden
        const waitMinutes = intervals[Math.min(data.level, intervals.length - 1)];
        data.nextReview = now + (waitMinutes * 60000);
    } else {
        data.level = 0; // Yanlƒ±≈üta ba≈üa d√∂n
        data.nextReview = now; // Hemen tekrar sorulabilir
    }

    originalFinalizeRound(isCorrect);
};

console.log("üöÄ SRS Algoritmasƒ± Aktif: Kelimeler artƒ±k √∂ƒürenme hƒ±zƒ±nƒ±za g√∂re gelecek.");

const statusRenderWord = renderWord;
renderWord = function() {
    statusRenderWord(); // Orijinal render fonksiyonunu √ßaƒüƒ±r
    
    // Bilgi kutusunu olu≈ütur veya g√ºncelle
    let statusBox = document.getElementById('srs-status');
    if (!statusBox) {
        statusBox = document.createElement('div');
        statusBox.id = 'srs-status';
        statusBox.style = "font-size: 0.65rem; font-weight: 800; color: var(--primary-light); margin-top: -11px; margin-bottom: 10px; text-align: center; text-transform: uppercase; letter-spacing: 1px;";
        document.getElementById('tags-box').after(statusBox);
    }

    const data = srsData[currentItem.eng];
    if (data && data.level > 0) {
        const levelStars = "‚≠ê".repeat(Math.min(data.level, 5));
        statusBox.innerText = `√ñƒürenme Seviyesi: ${levelStars}`;
    } else {
        statusBox.innerText = "YENƒ∞ KELƒ∞ME ‚ú®";
    }
};
</script>
</body>
</html>
