<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Oxford 3000 Pro - Modern Edition</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;600;800&display=swap" rel="stylesheet">
    
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>

    <style>
        :root { --primary: #4f46e5; --primary-light: #818cf8; --success: #10b981; --expert: #059669; --warning: #f59e0b; --error: #ef4444; --bg: #f1f5f9; --text: #0f172a; --card: #ffffff; }
        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; margin: 0; padding: 0; }
        
        body { 
            font-family: 'Plus Jakarta Sans', sans-serif; 
            background: var(--bg); 
            height: 100vh; 
            height: -webkit-fill-available; 
            display: flex; 
            justify-content: center; 
            align-items: center; 
            color: var(--text); 
            overflow: hidden; /* Kaydƒ±rmayƒ± tamamen kapatƒ±r */
        }

        /* Ana Konteynƒ±rƒ± Ekran Boyutuna Sabitleme */
        .container { 
            background: var(--card); 
            width: 100%; 
            max-width: 480px; 
            height: 100vh; /* Mobil ekranƒ±n tamamƒ±nƒ± kapla */
            padding: 16px; 
            display: flex; 
            flex-direction: column; 
            position: relative;
        }

        @media (min-width: 500px) { 
            .container { height: 90vh; border-radius: 32px; box-shadow: 0 25px 50px -12px rgba(0,0,0,0.1); } 
        }

        /* √úst Men√º */
        .menu-bar { 
            display: flex; 
            justify-content: space-between; 
            gap: 8px; 
            margin-bottom: 15px; 
            background: #f8fafc; 
            border-radius: 16px; 
            padding: 6px; 
            border: 1px solid #f1f5f9; 
            flex-shrink: 0; /* Boyutunun k√º√ß√ºlmesini engelle */
        }
        .menu-item { flex: 1; font-size: 0.65rem; font-weight: 800; text-align: center; cursor: pointer; color: #64748b; padding: 10px 4px; border-radius: 12px; transition: all 0.2s; }
        .active-user { color: var(--primary); background: white; box-shadow: 0 4px 6px -1px rgba(0,0,0,0.05); }

        /* Filtreler */
        .filter-panel { display: grid; grid-template-columns: 1fr 1fr; gap: 8px; margin-bottom: 15px; flex-shrink: 0; }
        select { appearance: none; background: #f1f5f9; border: 2px solid transparent; padding: 10px; border-radius: 12px; font-weight: 600; font-size: 0.8rem; color: #475569; outline: none; }

        /* Kelime Alanƒ± - Ekranƒ±n ortasƒ±nda kalan bo≈üluƒüu bu dolduracak */
        .game-main { 
            flex: 1; 
            display: flex; 
            flex-direction: column; 
            justify-content: center; 
            align-items: center; 
            text-align: center;
        }

        #target-word { 
            font-size: 3rem; 
            font-weight: 800; 
            color: #1e293b; 
            letter-spacing: -1.5px; 
            line-height: 1; 
            margin: 10px 0;
            animation: fadeIn 0.4s ease;
            word-break: break-word;
        }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        
        .tags-container { display: flex; justify-content: center; gap: 6px; margin-bottom: 12px; }
        .tag { padding: 4px 10px; border-radius: 10px; font-size: 0.65rem; font-weight: 800; text-transform: uppercase; }
        .tag-lvl { background: #e0e7ff; color: #4338ca; }
        .tag-info { background: #fef3c7; color: #92400e; }

        /* Alt Kƒ±sƒ±m - Giri≈ü ve Buton */
        .input-group { margin-top: auto; padding-bottom: 10px; flex-shrink: 0; }
        #feedback { font-weight: 700; height: 24px; margin-bottom: 5px; font-size: 0.9rem; text-align: center; }
        input { width: 100%; padding: 16px; border: 2px solid #e2e8f0; border-radius: 20px; font-size: 1.1rem; font-weight: 600; outline: none; text-align: center; background: #f8fafc; transition: all 0.3s; }
        input:focus { border-color: var(--primary); background: white; }
        
        #action-btn { width: 100%; padding: 18px; border: none; border-radius: 20px; background: var(--primary); color: white; font-size: 1.1rem; font-weight: 700; cursor: pointer; margin-top: 12px; box-shadow: 0 8px 15px -3px rgba(79, 70, 229, 0.3); }

        /* Overlay & Modals */
        #user-overlay { position: fixed; inset: 0; background: rgba(241, 245, 249, 0.98); backdrop-filter: blur(12px); z-index: 2000; display: flex; flex-direction: column; align-items: center; justify-content: center; padding: 20px; }
        .user-card { background: white; width: 100%; max-width: 320px; padding: 14px; margin: 8px 0; border-radius: 16px; display: flex; justify-content: space-between; align-items: center; border: 1px solid #e2e8f0; }
        .google-btn { background: white; border: 1px solid #e2e8f0; padding: 14px; border-radius: 18px; font-weight: 700; cursor: pointer; display: flex; align-items: center; justify-content: center; gap: 10px; width: 100%; max-width: 320px; margin-bottom: 15px; }

        .modal { display: none; position: fixed; inset: 0; background: rgba(15, 23, 42, 0.6); backdrop-filter: blur(8px); z-index: 3000; align-items: center; justify-content: center; padding: 15px; }
        .modal-content { background: white; width: 100%; max-width: 400px; border-radius: 24px; padding: 20px; max-height: 85vh; overflow-y: auto; }
        
        .progress-row { margin-bottom: 12px; padding: 10px; background: #f8fafc; border-radius: 14px; border: 1px solid #f1f5f9; }
        .progress-bar { background: #e2e8f0; height: 8px; border-radius: 4px; overflow: hidden; margin: 4px 0; }
        .progress-fill { height: 100%; background: var(--primary); }
        .expert-fill { height: 100%; background: var(--success); }
        .shake { animation: shake 0.4s both; border-color: var(--warning) !important; }
        @keyframes shake { 10%, 90% { transform: translate3d(-1px, 0, 0); } 20%, 80% { transform: translate3d(2px, 0, 0); } 30%, 50%, 70% { transform: translate3d(-4px, 0, 0); } }
    </style>
</head>
<body>

<div id="user-overlay">
    <div style="text-align:center; margin-bottom:20px">
        <h1 style="font-weight:800; font-size:1.8rem; margin:0; letter-spacing:-1px">Oxford 3000<span style="color:var(--primary)">.</span></h1>
        <p style="color:#64748b; font-weight:600; font-size: 0.9rem">√ñƒürenme yolculuƒüuna ba≈üla</p>
    </div>

    <button class="google-btn" onclick="loginWithGoogle()">
        <img src="https://www.gstatic.com/firebasejs/ui/2.0.0/images/auth/google.svg" width="18">
        Google ile Giri≈ü Yap
    </button>
    <div style="color:#cbd5e1; font-size:0.75rem; margin-bottom:10px;">‚Äî VEYA YEREL DEVAM ET ‚Äî</div>

    <div id="user-list" style="width:100%; display:flex; flex-direction:column; align-items:center; max-height:25vh; overflow-y:auto;"></div>
    <div style="width:100%; max-width:320px; margin-top:15px; padding-top:15px; border-top:1px solid #e2e8f0">
        <input type="text" id="new-username" placeholder="√ñƒürenci ƒ∞smi" style="font-size:0.9rem; padding:12px; background:white">
        <button onclick="createUser()" style="width:100%; margin-top:8px; padding:12px; border-radius:14px; background:var(--text); color:white; border:none; font-weight:700; cursor:pointer">PROFƒ∞L OLU≈ûTUR</button>
    </div>
</div>

<div class="container">
    <div class="menu-bar">
        <div id="active-user-name" class="menu-item active-user" onclick="location.reload()">üë§ Profil</div>
        <div class="menu-item" onclick="toggleModal('mistake-modal', true)">‚ö†Ô∏è HATALAR (<span id="wrong-count">0</span>)</div>
        <div class="menu-item" onclick="openStats()">üìä ƒ∞STATƒ∞STƒ∞K</div>
    </div>

    <div class="filter-panel">
        <select id="level-filter" onchange="applyFilters()"><option value="ALL">Seviye: T√ºm√º</option><option value="A1">A1</option><option value="A2">A2</option><option value="B1">B1</option><option value="B2">B2</option><option value="C1">C1</option></select>
        <select id="type-filter" onchange="applyFilters()"><option value="ALL">T√ºr: T√ºm√º</option><option value="v.">Fiil</option><option value="n.">ƒ∞sim</option><option value="adj.">Sƒ±fat</option><option value="adv.">Zarf</option></select>
    </div>

    <div class="game-main">
        <div class="tags-container" id="tags-box"></div>
        <div onclick="speakWord()" style="cursor:pointer">
            <div id="target-word">...</div>
            <div style="font-size: 0.7rem; color: var(--primary); font-weight: 800; letter-spacing: 1px;">üîä TELAFFUZU Dƒ∞NLE</div>
        </div>
    </div>

    <div class="input-group">
        <div id="feedback"></div>
        <input type="text" id="user-input" placeholder="T√ºrk√ße kar≈üƒ±lƒ±ƒüƒ±nƒ± yaz..." autocomplete="off">
        <button id="action-btn">KONTROL ET</button>
    </div>
</div>

<div id="stats-modal" class="modal">
    <div class="modal-content">
        <h2 style="font-weight:800; margin-bottom:15px; font-size:1.2rem">Geli≈üim Analizi</h2>
        <canvas id="statsChart" style="max-height:140px; margin-bottom:15px;"></canvas>
        <div id="level-bars"></div>
        <button onclick="toggleModal('stats-modal', false)" style="width:100%; margin-top:10px; padding:12px; border-radius:14px; border:none; background:#f1f5f9; color:var(--text); font-weight:700; cursor:pointer">KAPAT</button>
    </div>
</div>

<div id="mistake-modal" class="modal">
    <div class="modal-content">
        <h2 style="font-weight:800; margin-bottom:15px; font-size:1.2rem">Hatalƒ± Kelimeler</h2>
        <div id="mistake-list-container" style="max-height:45vh; overflow-y:auto"></div>
        <button onclick="toggleModal('mistake-modal', false)" style="width:100%; margin-top:15px; padding:12px; border-radius:14px; border:none; background:#f1f5f9; color:var(--text); font-weight:700">KAPAT</button>
    </div>
</div>

<script>
    // --- FIREBASE CONFIG (DEƒûƒ∞≈ûMEDƒ∞) ---
    const firebaseConfig = {
        apiKey: "AIzaSyCM5M27q4r-gxhkQoc1XEyGU7JCI1Nzk5M",
        authDomain: "kelimelik-43169.firebaseapp.com",
        projectId: "kelimelik-43169",
        storageBucket: "kelimelik-43169.firebasestorage.app",
        messagingSenderId: "1065593596358",
        appId: "1:1065593596358:web:d34ad0df91fd9efd252ac7"
    };
    firebase.initializeApp(firebaseConfig);
    const auth = firebase.auth();
    const db = firebase.firestore();

    // --- T√úM MANTIK VE FONKSƒ∞YONLAR (DEƒûƒ∞≈ûMEDƒ∞) ---
    let masterDict = [];
    let users = JSON.parse(localStorage.getItem('ox_users')) || [];
    let currentUser = null;
    let srsData = {};
    let filteredDict = [];
    let currentItem = null, myChart = null, secondChanceActive = false;
    const levels = ['A1', 'A2', 'B1', 'B2', 'C1'], types = ['v.', 'n.', 'adj.', 'adv.'];

    function initUserSystem() {
        const list = document.getElementById('user-list');
        list.innerHTML = "";
        users.forEach(u => {
            const div = document.createElement('div');
            div.className = 'user-card';
            div.innerHTML = `<span onclick="selectUser('${u}')" style="flex:1; font-weight:700;">${u}</span><span style="color:var(--error); font-weight:800; font-size:0.7rem; padding:5px" onclick="deleteUser('${u}')">Sƒ∞L</span>`;
            list.appendChild(div);
        });
    }

    async function loginWithGoogle() {
        const provider = new firebase.auth.GoogleAuthProvider();
        try {
            const result = await auth.signInWithPopup(provider);
            const user = result.user;
            currentUser = user.displayName;
            const doc = await db.collection("users").doc(user.uid).get();
            srsData = doc.exists ? (doc.data().srsData || {}) : {};
            document.getElementById('user-overlay').style.display = 'none';
            document.getElementById('active-user-name').innerText = "üë§ " + currentUser.split(' ')[0];
            loadCSV();
        } catch (error) { alert("Google Giri≈üi Ba≈üarƒ±sƒ±z."); }
    }

    function createUser() {
        const name = document.getElementById('new-username').value.trim();
        if(!name || users.includes(name)) return alert("Ge√ßersiz isim!");
        users.push(name);
        localStorage.setItem('ox_users', JSON.stringify(users));
        document.getElementById('new-username').value = "";
        initUserSystem();
    }

    function deleteUser(name) {
        if(!confirm(name + " silinsin mi?")) return;
        users = users.filter(u => u !== name);
        localStorage.removeItem('ox_srs_' + name);
        localStorage.setItem('ox_users', JSON.stringify(users));
        initUserSystem();
    }

    function selectUser(name) {
        currentUser = name;
        const savedData = localStorage.getItem('ox_srs_' + name);
        srsData = savedData ? JSON.parse(savedData) : {};
        document.getElementById('user-overlay').style.display = 'none';
        document.getElementById('active-user-name').innerText = "üë§ " + name;
        loadCSV();
    }

    async function loadCSV() {
        try {
            const res = await fetch('kelimeler.csv');
            const data = await res.text();
            const rows = data.split('\n').slice(1);
            masterDict = rows.map(row => {
                const cols = row.split(/,(?=(?:(?:[^"]*"){2})*[^"]*$)/).map(c => c.trim().replace(/^"|"$/g, ''));
                if(cols[0] && cols[cols.length-1]) {
                    return { eng: cols[0], tr: cols[cols.length-1], level: cols.find(c => levels.includes(c.toUpperCase())) || "A1", types: [cols.find(c => types.includes(c.toLowerCase())) || "n."] };
                }
            }).filter(i => i);
            applyFilters();
            updateUI();
        } catch (e) { console.error("CSV y√ºklenemedi."); }
    }

    function applyFilters() {
        const sL = document.getElementById('level-filter').value;
        const sT = document.getElementById('type-filter').value;
        filteredDict = masterDict.filter(i => (sL === "ALL" || i.level === sL) && (sT === "ALL" || i.types.includes(sT)));
        getNextWord();
    }

    function getNextWord() {
        if (!filteredDict.length) return;
        secondChanceActive = false;
        const mists = filteredDict.filter(i => srsData[i.eng]?.isMistake);
        currentItem = (mists.length > 0 && Math.random() < 0.3) ? mists[Math.floor(Math.random() * mists.length)] : filteredDict[Math.floor(Math.random() * filteredDict.length)];
        renderWord();
    }

    function renderWord() {
        document.getElementById('target-word').innerText = currentItem.eng;
        document.getElementById('tags-box').innerHTML = `<span class="tag tag-lvl">${currentItem.level}</span><span class="tag tag-info">${currentItem.types[0]}</span>`;
        const inp = document.getElementById('user-input');
        inp.value = ""; inp.disabled = false; inp.focus(); inp.classList.remove('shake');
        document.getElementById('action-btn').innerText = "KONTROL ET";
        document.getElementById('action-btn').style.background = "var(--primary)";
        document.getElementById('action-btn').onclick = checkAnswer;
        document.getElementById('feedback').innerText = "";
    }

    function checkAnswer() {
        const val = document.getElementById('user-input').value.trim().toLowerCase();
        const ans = currentItem.tr.toLowerCase().split(',').map(a => a.trim());
        const fb = document.getElementById('feedback');
        if (ans.includes(val)) {
            fb.innerText = "‚ú® DOƒûRU!"; fb.style.color = "var(--success)";
            if (!srsData[currentItem.eng]) srsData[currentItem.eng] = { level: 0, isMistake: false };
            srsData[currentItem.eng].level++; srsData[currentItem.eng].isMistake = false;
            finalizeRound(true);
        } else {
            if (!secondChanceActive) {
                fb.innerText = "üéØ Tekrar dene!"; fb.style.color = "var(--warning)";
                document.getElementById('user-input').classList.add('shake'); secondChanceActive = true;
                setTimeout(() => document.getElementById('user-input').classList.remove('shake'), 400);
            } else {
                fb.innerText = `üí° ${currentItem.tr}`; fb.style.color = "var(--error)";
                if (!srsData[currentItem.eng]) srsData[currentItem.eng] = { level: 0, isMistake: false };
                srsData[currentItem.eng].isMistake = true;
                finalizeRound(false);
            }
        }
    }

    function finalizeRound(isCorrect) {
        localStorage.setItem('ox_srs_' + currentUser, JSON.stringify(srsData));
        if (auth.currentUser) {
            db.collection("users").doc(auth.currentUser.uid).set({ srsData: srsData, lastUpdated: firebase.firestore.FieldValue.serverTimestamp() }, { merge: true });
        }
        updateUI();
        document.getElementById('user-input').disabled = true;
        document.getElementById('action-btn').innerText = "SIRADAKƒ∞";
        document.getElementById('action-btn').style.background = isCorrect ? "var(--success)" : "var(--error)";
        document.getElementById('action-btn').onclick = getNextWord;
    }

    function updateUI() {
        const mCount = Object.values(srsData).filter(v => v.isMistake).length;
        document.getElementById('wrong-count').innerText = mCount;
        const mList = masterDict.filter(i => srsData[i.eng]?.isMistake);
        document.getElementById('mistake-list-container').innerHTML = mList.map(m => `<div style="padding:10px; border-bottom:1px solid #f1f5f9; display:flex; justify-content:space-between; font-size:0.85rem"><b>${m.eng}</b> <span style="color:#64748b">${m.tr}</span></div>`).join('');
    }

    function openStats() {
        toggleModal('stats-modal', true);
        const data = Object.values(srsData);
        const stats = { new: masterDict.length - data.length, learn: data.filter(v => v.level > 0 && v.level < 4 && !v.isMistake).length, exp: data.filter(v => v.level >= 4).length, mist: data.filter(v => v.isMistake).length };
        const ctx = document.getElementById('statsChart').getContext('2d');
        if(myChart) myChart.destroy();
        myChart = new Chart(ctx, { type: 'doughnut', data: { labels: ['Yeni', '√ñƒüreniliyor', 'Uzman', 'Hatalƒ±'], datasets: [{ data: [stats.new, stats.learn, stats.exp, stats.mist], backgroundColor: ['#e2e8f0','#4f46e5','#10b981','#ef4444'], borderWeight:0 }] }, options: { plugins: { legend: { display: false } }, cutout: '75%' } });
        let h = "";
        levels.forEach(l => {
            const total = masterDict.filter(i => i.level === l).length;
            const lr = masterDict.filter(i => i.level === l && srsData[i.eng]?.level > 0).length;
            const pL = total > 0 ? Math.round((lr/total)*100) : 0;
            h += `<div class="progress-row"><div style="display:flex; justify-content:space-between; font-size:0.7rem; font-weight:800; margin-bottom:4px"><span>${l} Seviyesi</span><span>${lr}/${total}</span></div><div class="progress-bar"><div class="progress-fill" style="width:${pL}%"></div></div></div>`;
        });
        document.getElementById('level-bars').innerHTML = h;
    }

    function speakWord() { window.speechSynthesis.cancel(); const u = new SpeechSynthesisUtterance(currentItem.eng); u.lang = 'en-US'; u.rate = 0.85; window.speechSynthesis.speak(u); }
    function toggleModal(id, show) { document.getElementById(id).style.display = show ? 'flex' : 'none'; }
    document.getElementById('user-input').addEventListener("keypress", (e) => { if(e.key === "Enter") document.getElementById('action-btn').click(); });
    window.onload = initUserSystem;
</script>
</body>
</html>
